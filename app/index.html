<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlightSuite ‚Äî My Account</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" type="image/svg+xml" href="/Assets/Flight Suite Favicon vPurple.svg">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --blue:    #0071E3;
            --purple:  #5E5CE6;
            --green:   #34C759;
            --red:     #FF3B30;
            --orange:  #FF9500;
            --t1:      #1D1D1F;
            --t2:      #6E6E73;
            --t3:      #86868B;
            --bg:      #F5F5F7;
            --surface: #FFFFFF;
            --border:  #D2D2D7;
            --border-l:#E8E8ED;
            --grad:    linear-gradient(135deg, var(--purple) 0%, var(--blue) 100%);
            --fd:      -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", sans-serif;
            --ft:      -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
            --ease:    cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --spring:  cubic-bezier(0.34, 1.56, 0.64, 1);
            --out:     cubic-bezier(0.16, 1, 0.3, 1);
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body {
            font-family: var(--ft);
            color: var(--t1);
            background: var(--bg);
            font-size: 15px;
            line-height: 1.47;
            letter-spacing: -0.022em;
            min-height: 100vh;
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        #login-view {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            background: #fff;
        }
        #login-view::before {
            content: '';
            position: absolute;
            top: -200px; left: -200px;
            width: 600px; height: 600px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(94,92,230,0.14) 0%, transparent 70%);
            pointer-events: none;
        }
        #login-view::after {
            content: '';
            position: absolute;
            bottom: -150px; right: -150px;
            width: 500px; height: 500px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(0,113,227,0.10) 0%, transparent 70%);
            pointer-events: none;
        }

        .login-wrap {
            position: relative;
            z-index: 1;
            width: 100%;
            max-width: 420px;
            padding: 16px;
        }
        .login-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 32px;
        }
        .login-logo img { width: 34px; height: 34px; }
        .login-logo span {
            font-family: var(--fd);
            font-size: 22px;
            font-weight: 700;
            letter-spacing: -0.05em;
            color: var(--t1);
        }

        .login-card {
            background: var(--surface);
            border-radius: 24px;
            padding: 40px 36px;
            box-shadow:
                0 0 0 1px rgba(0,0,0,0.04),
                0 4px 6px rgba(0,0,0,0.04),
                0 16px 48px rgba(0,0,0,0.08);
        }
        .login-title {
            font-family: var(--fd);
            font-size: 26px;
            font-weight: 700;
            letter-spacing: -0.04em;
            margin-bottom: 6px;
        }
        .login-sub {
            font-size: 14px;
            color: var(--t2);
            margin-bottom: 28px;
            line-height: 1.5;
        }

        /* Google button */
        #gsi-wrap { display: flex; justify-content: center; margin-bottom: 18px; }
        .btn-google {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 20px;
            background: var(--surface);
            border: 1.5px solid var(--border);
            border-radius: 12px;
            font-family: var(--ft);
            font-size: 15px;
            font-weight: 500;
            color: var(--t1);
            cursor: pointer;
            transition: border-color .15s, box-shadow .15s;
            margin-bottom: 18px;
        }
        .btn-google:hover { border-color: #999; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }

        .divider {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--t3);
            font-size: 13px;
            margin-bottom: 18px;
        }
        .divider::before, .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-l);
        }

        .field { margin-bottom: 12px; }
        .field-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--t2);
            margin-bottom: 6px;
        }
        .field-input {
            width: 100%;
            padding: 12px 14px;
            border: 1.5px solid var(--border);
            border-radius: 12px;
            font-family: var(--ft);
            font-size: 15px;
            color: var(--t1);
            background: var(--surface);
            outline: none;
            transition: border-color .15s, box-shadow .15s;
        }
        .field-input:focus {
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0,113,227,.1);
        }
        .field-input::placeholder { color: var(--t3); }

        .btn-primary {
            width: 100%;
            padding: 13px 20px;
            background: var(--blue);
            color: #fff;
            border: none;
            border-radius: 12px;
            font-family: var(--ft);
            font-size: 15px;
            font-weight: 600;
            letter-spacing: -.01em;
            cursor: pointer;
            transition: opacity .15s, transform .1s;
        }
        .btn-primary:hover { opacity: .88; }
        .btn-primary:active { transform: scale(.98); }
        .btn-primary:disabled { opacity: .45; cursor: not-allowed; transform: none; }

        .otp-back {
            background: none;
            border: none;
            color: var(--blue);
            font-family: var(--ft);
            font-size: 13px;
            cursor: pointer;
            padding: 0;
            margin-bottom: 16px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .resend-row {
            text-align: center;
            margin-top: 12px;
            font-size: 13px;
            color: var(--t2);
        }
        .resend-btn {
            background: none;
            border: none;
            color: var(--blue);
            cursor: pointer;
            font-family: var(--ft);
            font-size: 13px;
        }

        .err-box {
            background: rgba(255,59,48,.07);
            border: 1px solid rgba(255,59,48,.2);
            border-radius: 10px;
            padding: 10px 14px;
            font-size: 13px;
            color: var(--red);
            margin-bottom: 12px;
            display: none;
            text-align: left;
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        #dash-view { display: none; }

        /* Topbar */
        .topbar {
            background: rgba(255,255,255,.9);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid var(--border-l);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .topbar-inner {
            max-width: 1080px;
            margin: 0 auto;
            padding: 0 24px;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .topbar-logo {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            font-family: var(--fd);
            font-size: 17px;
            font-weight: 600;
            letter-spacing: -.03em;
            color: var(--t1);
        }
        .topbar-logo img { width: 26px; height: 26px; }
        .topbar-right { display: flex; align-items: center; gap: 6px; }
        .topbar-email { font-size: 13px; color: var(--t3); }
        .btn-ghost {
            background: none;
            border: none;
            font-family: var(--ft);
            font-size: 13px;
            color: var(--t2);
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 8px;
            transition: background .15s, color .15s;
        }
        .btn-ghost:hover { background: var(--bg); color: var(--t1); }

        /* Page */
        .page {
            max-width: 1080px;
            margin: 0 auto;
            padding: 36px 24px 80px;
        }

        /* Welcome header */
        .welcome-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 28px;
            flex-wrap: wrap;
        }
        .welcome-text {}
        .welcome-greeting {
            font-family: var(--fd);
            font-size: clamp(26px, 3.5vw, 36px);
            font-weight: 700;
            letter-spacing: -.04em;
            line-height: 1.1;
        }
        .welcome-email { font-size: 14px; color: var(--t2); margin-top: 4px; }
        .tier-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: .01em;
            flex-shrink: 0;
        }
        .tier-pill .dot { width: 6px; height: 6px; border-radius: 50%; }
        .tier-free    { background: rgba(110,110,115,.1);  color: var(--t2); }
        .tier-free    .dot { background: var(--t3); }
        .tier-starter { background: rgba(0,113,227,.08);   color: var(--blue); }
        .tier-starter .dot { background: var(--blue); }
        .tier-pro     { background: rgba(94,92,230,.08);   color: var(--purple); }
        .tier-pro     .dot { background: var(--purple); }
        .tier-business{ background: rgba(52,199,89,.1);    color: #1c7a38; }
        .tier-business .dot { background: var(--green); }

        /* Success banner */
        .banner-success {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(52,199,89,.08);
            border: 1px solid rgba(52,199,89,.25);
            border-radius: 14px;
            padding: 14px 18px;
            margin-bottom: 24px;
            font-size: 14px;
            color: #1c7a38;
        }
        .banner-success .banner-icon { font-size: 20px; flex-shrink: 0; }

        /* Cards grid */
        .grid-top {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin-bottom: 14px;
        }
        .grid-bottom {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }

        /* Card base */
        .card {
            background: var(--surface);
            border-radius: 20px;
            padding: 24px;
            box-shadow:
                0 0 0 1px rgba(0,0,0,0.03),
                0 2px 4px rgba(0,0,0,0.04),
                0 8px 24px rgba(0,0,0,0.04);
        }
        .card-title {
            font-family: var(--fd);
            font-size: 13px;
            font-weight: 600;
            letter-spacing: .04em;
            text-transform: uppercase;
            color: var(--t3);
            margin-bottom: 16px;
        }

        /* ‚îÄ‚îÄ Credits card ‚îÄ‚îÄ */
        .credits-numbers {
            display: flex;
            align-items: baseline;
            gap: 6px;
            margin-bottom: 8px;
        }
        .credits-big {
            font-family: var(--fd);
            font-size: 42px;
            font-weight: 700;
            letter-spacing: -.05em;
            line-height: 1;
        }
        .credits-of { font-size: 16px; color: var(--t3); font-weight: 400; }
        .credits-label { font-size: 13px; color: var(--t2); margin-bottom: 12px; }

        .progress-track {
            height: 8px;
            background: var(--bg);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            background: var(--grad);
            transition: width .8s var(--out);
        }
        .progress-fill.warn  { background: var(--orange); }
        .progress-fill.over  { background: var(--red); }

        .credits-remaining {
            font-size: 13px;
            color: var(--t2);
        }
        .credits-remaining .highlight { font-weight: 600; color: var(--t1); }

        /* ‚îÄ‚îÄ Subscription card ‚îÄ‚îÄ */
        .sub-plan-name {
            font-family: var(--fd);
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -.04em;
            margin-bottom: 4px;
        }
        .sub-status-row {
            display: flex;
            align-items: center;
            gap: 7px;
            font-size: 13px;
            color: var(--t2);
            margin-bottom: 16px;
        }
        .sub-dot { width: 7px; height: 7px; border-radius: 50%; }
        .sub-dot.active    { background: var(--green); }
        .sub-dot.cancelled { background: var(--t3); }
        .sub-dot.none      { background: var(--border); }

        .sub-renew { font-size: 12px; color: var(--t3); margin-bottom: 16px; }
        .sub-cta-row { display: flex; gap: 8px; flex-wrap: wrap; }
        .btn-upgrade {
            flex: 1;
            min-width: 110px;
            padding: 11px 18px;
            background: var(--grad);
            color: #fff;
            border: none;
            border-radius: 11px;
            font-family: var(--ft);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity .15s, transform .1s;
            text-align: center;
        }
        .btn-upgrade:hover { opacity: .88; }
        .btn-upgrade:active { transform: scale(.97); }
        .btn-manage {
            flex: 1;
            min-width: 110px;
            padding: 11px 18px;
            background: var(--bg);
            color: var(--t1);
            border: none;
            border-radius: 11px;
            font-family: var(--ft);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background .15s;
            text-align: center;
        }
        .btn-manage:hover { background: #e5e5ea; }

        /* ‚îÄ‚îÄ CRM card ‚îÄ‚îÄ */
        .crm-list { display: flex; flex-direction: column; gap: 10px; }
        .crm-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            background: var(--bg);
            border-radius: 13px;
            animation: fadeIn .3s var(--out);
        }
        .crm-logo {
            width: 38px;
            height: 38px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 800;
            flex-shrink: 0;
            letter-spacing: -.02em;
        }
        .crm-logo.hs  { background: rgba(255,122,0,.1); color: #f07900; }
        .crm-logo.ghl { background: rgba(94,92,230,.08); color: var(--purple); }
        .crm-info { flex: 1; min-width: 0; }
        .crm-name { font-size: 14px; font-weight: 600; line-height: 1.2; }
        .crm-account { font-size: 12px; color: var(--t2); margin-top: 2px; }
        .crm-date { font-size: 11px; color: var(--t3); margin-top: 1px; }
        .btn-text-danger {
            font-size: 12px;
            color: var(--red);
            background: none;
            border: none;
            cursor: pointer;
            font-family: var(--ft);
            font-weight: 500;
            padding: 6px 10px;
            border-radius: 8px;
            transition: background .15s;
            flex-shrink: 0;
        }
        .btn-text-danger:hover { background: rgba(255,59,48,.06); }

        .empty-state {
            text-align: center;
            padding: 20px 0 8px;
        }
        .empty-icon { font-size: 32px; margin-bottom: 8px; }
        .empty-text { font-size: 13px; color: var(--t2); margin-bottom: 14px; }

        .btn-add {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 18px;
            background: var(--bg);
            border: 1.5px dashed var(--border);
            border-radius: 11px;
            font-family: var(--ft);
            font-size: 13px;
            font-weight: 500;
            color: var(--t2);
            cursor: pointer;
            width: 100%;
            justify-content: center;
            transition: background .15s, border-color .15s, color .15s;
            text-decoration: none;
            margin-top: 10px;
        }
        .btn-add:hover { background: #e8e8ed; border-color: #aaa; color: var(--t1); }

        /* ‚îÄ‚îÄ Phone card ‚îÄ‚îÄ */
        .phone-list { display: flex; flex-direction: column; gap: 10px; }
        .phone-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            background: var(--bg);
            border-radius: 13px;
            animation: fadeIn .3s var(--out);
        }
        .phone-icon {
            width: 38px;
            height: 38px;
            border-radius: 9px;
            background: rgba(52,199,89,.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        .phone-info { flex: 1; min-width: 0; }
        .phone-number { font-size: 14px; font-weight: 600; }
        .phone-route { font-size: 12px; color: var(--t2); margin-top: 2px; }
        .phone-date { font-size: 11px; color: var(--t3); margin-top: 1px; }

        /* Phone registration inline */
        .phone-reg { margin-top: 4px; }
        .input-row { display: flex; gap: 8px; }
        .input-row .field-input { flex: 1; }
        .btn-sm {
            padding: 10px 16px;
            background: var(--bg);
            border: none;
            border-radius: 10px;
            font-family: var(--ft);
            font-size: 13px;
            font-weight: 500;
            color: var(--t1);
            cursor: pointer;
            white-space: nowrap;
            transition: background .15s;
            flex-shrink: 0;
        }
        .btn-sm:hover { background: #e5e5ea; }
        .btn-sm.blue { background: var(--blue); color: #fff; }
        .btn-sm.blue:hover { opacity: .88; }
        .phone-err { font-size: 12px; color: var(--red); margin-top: 6px; display: none; }

        /* ‚îÄ Skeleton ‚îÄ */
        .skel {
            background: linear-gradient(90deg, var(--bg) 25%, #ebebef 50%, var(--bg) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.4s infinite;
            border-radius: 6px;
        }
        @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

        /* Status dot inline */
        .dot-green { display: inline-block; width: 7px; height: 7px; border-radius: 50%; background: var(--green); margin-right: 5px; }

        /* Spinner */
        .spin {
            width: 16px; height: 16px;
            border: 2px solid rgba(0,0,0,.1);
            border-top-color: var(--blue);
            border-radius: 50%;
            animation: rot .7s linear infinite;
            display: inline-block;
        }
        @keyframes rot { to { transform: rotate(360deg); } }

        /* Fade in */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

        .hidden { display: none !important; }

        /* ‚îÄ Toast ‚îÄ */
        #toast {
            position: fixed;
            bottom: 28px;
            left: 50%;
            transform: translateX(-50%) translateY(80px);
            padding: 11px 22px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 24px rgba(0,0,0,0.14);
            transition: transform .3s var(--out);
            z-index: 999;
            pointer-events: none;
            white-space: nowrap;
        }
        #toast.show { transform: translateX(-50%) translateY(0); }
        #toast.ok  { background: var(--green); color: #fff; }
        #toast.bad { background: var(--red);   color: #fff; }

        /* Responsive */
        @media (max-width: 700px) {
            .grid-top, .grid-bottom { grid-template-columns: 1fr; }
            .login-card { padding: 32px 24px; }
            .page { padding: 24px 16px 60px; }
            .welcome-greeting { font-size: 26px; }
        }
    </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="login-view">
    <div class="login-wrap">
        <div class="login-logo">
            <img src="/Assets/Flight Suite Favicon vPurple.svg" alt="FlightSuite">
            <span>FlightSuite</span>
        </div>
        <div class="login-card">
            <h1 class="login-title">Sign in</h1>
            <p class="login-sub">Manage your plan, CRM connections, and phone numbers.</p>

            <!-- Google Sign-In -->
            <div id="gsi-wrap"></div>
            <button id="google-fallback" class="btn-google" onclick="manualGoogle()">
                <svg width="18" height="18" viewBox="0 0 18 18">
                    <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"/>
                    <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 0 0 9 18z"/>
                    <path fill="#FBBC05" d="M3.964 10.706A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.706V4.962H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.038l3.007-2.332z"/>
                    <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.962L3.964 7.294C4.672 5.163 6.656 3.58 9 3.58z"/>
                </svg>
                Continue with Google
            </button>

            <div class="divider">or continue with email</div>

            <!-- Email step -->
            <div id="step-email">
                <div id="err-email" class="err-box"></div>
                <div class="field">
                    <label class="field-label" for="inp-email">Email address</label>
                    <input id="inp-email" class="field-input" type="email" placeholder="you@company.com" autocomplete="email">
                </div>
                <button class="btn-primary" id="btn-send-otp" onclick="requestOtp()">Send sign-in code</button>
            </div>

            <!-- OTP step -->
            <div id="step-otp" class="hidden">
                <button class="otp-back" onclick="showEmailStep()">‚Üê Back</button>
                <div id="err-otp" class="err-box"></div>
                <div class="field">
                    <label class="field-label" for="inp-otp">6-digit code</label>
                    <input id="inp-otp" class="field-input" type="text" inputmode="numeric" maxlength="6" placeholder="000000" autocomplete="one-time-code">
                </div>
                <button class="btn-primary" id="btn-verify-otp" onclick="verifyOtp()">Sign in</button>
                <div class="resend-row">Didn't get it? <button class="resend-btn" onclick="requestOtp(true)">Resend code</button></div>
            </div>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="dash-view">

    <nav class="topbar">
        <div class="topbar-inner">
            <a href="/" class="topbar-logo">
                <img src="/Assets/Flight Suite Favicon vPurple.svg" alt="">
                FlightSuite
            </a>
            <div class="topbar-right">
                <span class="topbar-email" id="topbar-email"></span>
                <button class="btn-ghost" onclick="signOut()">Sign out</button>
            </div>
        </div>
    </nav>

    <div class="page">

        <!-- Success banner -->
        <div id="subscribed-banner" class="banner-success hidden">
            <span class="banner-icon">üéâ</span>
            <div><strong>Subscription activated!</strong> Your monthly credits are ready to use.</div>
        </div>

        <!-- Welcome header -->
        <div class="welcome-header">
            <div class="welcome-text">
                <div class="welcome-greeting" id="welcome-name">Welcome back</div>
                <div class="welcome-email" id="welcome-email"></div>
            </div>
            <div id="tier-pill" class="tier-pill tier-free">
                <span class="dot"></span>
                <span id="tier-label">Free</span>
            </div>
        </div>

        <!-- Top row: Credits + Subscription -->
        <div class="grid-top">

            <!-- Credits -->
            <div class="card">
                <div class="card-title">SMS &amp; WhatsApp Credits</div>
                <div id="credits-skel">
                    <div class="skel" style="height:42px; width:60%; margin-bottom:8px;"></div>
                    <div class="skel" style="height:8px; margin-bottom:8px;"></div>
                    <div class="skel" style="height:14px; width:50%;"></div>
                </div>
                <div id="credits-content" class="hidden">
                    <div class="credits-numbers">
                        <span class="credits-big" id="cred-used">‚Äî</span>
                        <span class="credits-of" id="cred-limit-label"></span>
                    </div>
                    <div class="credits-label" id="cred-context-label"></div>
                    <div class="progress-track">
                        <div class="progress-fill" id="cred-bar" style="width:0%"></div>
                    </div>
                    <div class="credits-remaining" id="cred-remaining"></div>
                </div>
            </div>

            <!-- Subscription -->
            <div class="card">
                <div class="card-title">Subscription</div>
                <div id="sub-skel">
                    <div class="skel" style="height:28px; width:45%; margin-bottom:10px;"></div>
                    <div class="skel" style="height:14px; width:65%; margin-bottom:16px;"></div>
                    <div class="skel" style="height:42px;"></div>
                </div>
                <div id="sub-content" class="hidden">
                    <div class="sub-plan-name" id="sub-plan-name">Free</div>
                    <div class="sub-status-row">
                        <div class="sub-dot none" id="sub-dot"></div>
                        <span id="sub-status-text">No active subscription</span>
                    </div>
                    <div class="sub-renew hidden" id="sub-renew"></div>
                    <div class="sub-cta-row">
                        <button class="btn-upgrade hidden" id="btn-upgrade" onclick="startUpgrade()">Upgrade plan ‚Üí</button>
                        <button class="btn-manage hidden" id="btn-manage" onclick="openPortal()">Manage subscription</button>
                    </div>
                </div>
            </div>

        </div>

        <!-- Bottom row: CRMs + Phone -->
        <div class="grid-bottom">

            <!-- Connected CRMs -->
            <div class="card">
                <div class="card-title">Connected CRMs</div>
                <div id="crm-skel">
                    <div class="skel" style="height:62px; border-radius:13px; margin-bottom:10px;"></div>
                </div>
                <div id="crm-content" class="hidden">
                    <div id="crm-list" class="crm-list"></div>
                    <a href="/app/connect" class="btn-add" id="btn-add-crm">
                        <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                            <path d="M7 1v12M1 7h12" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                        </svg>
                        Connect a CRM
                    </a>
                </div>
            </div>

            <!-- Phone Numbers -->
            <div class="card">
                <div class="card-title">Phone Numbers</div>
                <div id="phone-skel">
                    <div class="skel" style="height:62px; border-radius:13px; margin-bottom:10px;"></div>
                </div>
                <div id="phone-content" class="hidden">
                    <div id="phone-list" class="phone-list"></div>

                    <!-- Add phone form (shown when no phone linked, or to add more) -->
                    <div id="phone-add-section">
                        <div id="phone-step-number" class="phone-reg">
                            <div class="input-row">
                                <input id="inp-phone" class="field-input" type="tel" placeholder="+1 555 000 0000">
                                <button class="btn-sm blue" onclick="sendPhoneCode()">Send code</button>
                            </div>
                            <div id="phone-err" class="phone-err"></div>
                        </div>
                        <div id="phone-step-otp" class="phone-reg hidden">
                            <p style="font-size:13px; color:var(--t2); margin-bottom:8px;">Enter the code sent to your number:</p>
                            <div class="input-row">
                                <input id="inp-phone-otp" class="field-input" type="text" inputmode="numeric" maxlength="6" placeholder="000000">
                                <button class="btn-sm blue" onclick="verifyPhoneCode()">Verify</button>
                            </div>
                            <div id="phone-otp-err" class="phone-err"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div id="toast"></div>

<script>
const API = 'https://treasonable-refugio-uncoincidentally.ngrok-free.dev/api/v1';

// ‚îÄ‚îÄ Token ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tok()          { return localStorage.getItem('fs_token'); }
function setTok(t)      { localStorage.setItem('fs_token', t); }
function clearTok()     { localStorage.removeItem('fs_token'); localStorage.removeItem('fs_email'); }
function auth()         { return { 'Authorization': 'Bearer ' + tok(), 'Content-Type': 'application/json' }; }

// ‚îÄ‚îÄ Boot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded', () => {
    initGSI();
    if (tok()) {
        showDash();
    } else {
        document.getElementById('login-view').style.display = 'flex';
    }
    if (new URLSearchParams(location.search).get('subscribed') === 'true') {
        document.getElementById('subscribed-banner').classList.remove('hidden');
        history.replaceState({}, '', '/app');
    }
});

// ‚îÄ‚îÄ Google Sign-In ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initGSI() {
    if (typeof google === 'undefined') return;
    google.accounts.id.initialize({
        client_id: '1063285697384-4nqvgdp2ok8o98uusc1ql9qb8gbqsn04.apps.googleusercontent.com',
        callback: onGoogleCred
    });
    google.accounts.id.renderButton(
        document.getElementById('gsi-wrap'),
        { theme: 'outline', size: 'large', width: 348, text: 'continue_with' }
    );
    document.getElementById('google-fallback').classList.add('hidden');
}
function manualGoogle() {
    if (typeof google !== 'undefined') google.accounts.id.prompt();
}
async function onGoogleCred(res) {
    try {
        const r = await fetch(API + '/auth/google/token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id_token: res.credential })
        });
        const d = await r.json();
        if (!r.ok) throw new Error(d.detail || 'Google sign-in failed');
        setTok(d.user_token);
        if (d.email) localStorage.setItem('fs_email', d.email);
        showDash();
    } catch(e) { showErr('err-email', e.message); }
}

// ‚îÄ‚îÄ Email OTP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _email = '';
async function requestOtp(resend = false) {
    const email = document.getElementById('inp-email').value.trim();
    if (!email) { showErr('err-email', 'Please enter your email address.'); return; }
    _email = email;
    clearErr('err-email');
    setBtnLoading('btn-send-otp', 'Sending‚Ä¶');
    try {
        const r = await fetch(API + '/auth/email/request-otp', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
        });
        const d = await r.json();
        if (!r.ok) throw new Error(d.detail || 'Failed to send code');
        document.getElementById('step-email').classList.add('hidden');
        document.getElementById('step-otp').classList.remove('hidden');
        setTimeout(() => document.getElementById('inp-otp').focus(), 100);
    } catch(e) { showErr('err-email', e.message); }
    finally { resetBtn('btn-send-otp', 'Send sign-in code'); }
}
async function verifyOtp() {
    const code = document.getElementById('inp-otp').value.trim();
    if (code.length !== 6) { showErr('err-otp', 'Enter the 6-digit code.'); return; }
    clearErr('err-otp');
    setBtnLoading('btn-verify-otp', 'Verifying‚Ä¶');
    try {
        const r = await fetch(API + '/auth/email/verify-otp', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: _email, code })
        });
        const d = await r.json();
        if (!r.ok) throw new Error(d.detail || 'Invalid code');
        setTok(d.user_token);
        if (d.email) localStorage.setItem('fs_email', d.email);
        showDash();
    } catch(e) {
        showErr('err-otp', e.message);
        resetBtn('btn-verify-otp', 'Sign in');
    }
}
function showEmailStep() {
    document.getElementById('step-otp').classList.add('hidden');
    document.getElementById('step-email').classList.remove('hidden');
    clearErr('err-otp');
}

// ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showDash() {
    document.getElementById('login-view').style.display = 'none';
    document.getElementById('dash-view').style.display = 'block';
    const email = localStorage.getItem('fs_email') || '';
    document.getElementById('topbar-email').textContent = email;
    loadAll();
}
function signOut() { clearTok(); location.reload(); }

async function loadAll() {
    await Promise.all([ loadBilling(), loadUser() ]);
}

// ‚îÄ‚îÄ Billing ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadBilling() {
    try {
        const r = await fetch(API + '/billing/status', { headers: auth() });
        if (r.status === 401) { signOut(); return; }
        renderBilling(await r.json());
    } catch(e) { renderBilling({}); }
}
function renderBilling(d) {
    const tier   = (d.tier || 'free').toLowerCase();
    const used   = d.queries_sms_used   ?? 0;
    const limit  = d.queries_sms_limit  ?? 20;
    const status = (d.subscription_status || 'none').toLowerCase();
    const end    = d.period_end;
    const hasCust= !!d.stripe_customer_id;

    // Tier pill
    const pill = document.getElementById('tier-pill');
    const lbl  = document.getElementById('tier-label');
    pill.className = 'tier-pill tier-' + tier;
    lbl.textContent = tier.charAt(0).toUpperCase() + tier.slice(1);

    // Credits card
    const isFree  = tier === 'free';
    const isUnlim = limit === null || limit >= 99999;
    document.getElementById('cred-used').textContent = used;
    document.getElementById('cred-limit-label').textContent = isUnlim ? '/ ‚àû' : '/ ' + limit;
    document.getElementById('cred-context-label').textContent = isFree ? 'lifetime trial credits used' : 'credits used this month';

    const pct = isUnlim ? 10 : (limit > 0 ? Math.min((used / limit) * 100, 100) : 0);
    const bar = document.getElementById('cred-bar');
    bar.style.width = pct + '%';
    bar.className = 'progress-fill';
    if (!isUnlim) {
        if (used >= limit)         bar.classList.add('over');
        else if (used >= limit - 5) bar.classList.add('warn');
    }

    const rem = isUnlim ? null : (limit - used);
    const remEl = document.getElementById('cred-remaining');
    if (isUnlim) {
        remEl.innerHTML = '<span class="highlight">Unlimited</span> credits';
    } else if (rem <= 0) {
        remEl.innerHTML = '<span class="highlight" style="color:var(--red)">0 credits remaining</span> ¬∑ <a href="/subscribe" style="color:var(--blue); text-decoration:none; font-weight:500;">Upgrade ‚Üí</a>';
    } else if (rem <= 5) {
        remEl.innerHTML = '<span class="highlight" style="color:var(--orange)">' + rem + ' credits remaining</span> ¬∑ <a href="/subscribe" style="color:var(--blue); text-decoration:none; font-weight:500;">Upgrade ‚Üí</a>';
    } else {
        remEl.innerHTML = '<span class="highlight">' + rem + '</span> remaining';
    }

    hide('credits-skel'); show('credits-content');

    // Subscription card
    const names = { free:'Free', starter:'Starter', pro:'Pro', business:'Business' };
    document.getElementById('sub-plan-name').textContent = names[tier] || tier;

    const dot = document.getElementById('sub-dot');
    const stText = document.getElementById('sub-status-text');
    dot.className = 'sub-dot ' + (status === 'active' ? 'active' : status === 'cancelled' ? 'cancelled' : 'none');
    stText.textContent = status === 'active' ? 'Active subscription' : status === 'cancelled' ? 'Cancelled' : 'No active subscription';

    if (end) {
        const dt = new Date(typeof end === 'number' ? end * 1000 : end);
        const renew = document.getElementById('sub-renew');
        renew.textContent = 'Renews ' + dt.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        renew.classList.remove('hidden');
    }

    // CTA buttons
    if (hasCust) {
        show('btn-manage');
    } else {
        show('btn-upgrade');
    }
    // If paid tier, show manage alongside upgrade
    if (tier !== 'free' && hasCust) {
        hide('btn-upgrade');
        show('btn-manage');
    }

    hide('sub-skel'); show('sub-content');
}

// ‚îÄ‚îÄ /users/me ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadUser() {
    try {
        const r = await fetch(API + '/users/me', { headers: auth() });
        if (r.status === 401) { signOut(); return; }
        renderUser(await r.json());
    } catch(e) { renderUser({}); }
}
function renderUser(d) {
    // Welcome header
    const name  = d.name  || localStorage.getItem('fs_email') || 'there';
    const email = d.email || localStorage.getItem('fs_email') || '';
    document.getElementById('welcome-name').textContent  = 'Welcome back, ' + name.split(' ')[0] + '.';
    document.getElementById('welcome-email').textContent = email;
    document.getElementById('topbar-email').textContent  = email;
    localStorage.setItem('fs_email', email);

    // CRMs
    renderCRMs(d.crm_links || []);
    // Phones
    renderPhones(d.channels || []);
}

function renderCRMs(links) {
    hide('crm-skel'); show('crm-content');
    const list = document.getElementById('crm-list');

    if (links.length === 0) {
        list.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">üîå</div>
                <div class="empty-text">No CRMs connected yet</div>
            </div>`;
        document.getElementById('btn-add-crm').textContent = '+ Connect your first CRM';
        return;
    }

    list.innerHTML = links.map(l => {
        const isHS  = l.crm_type === 'hubspot';
        const label = isHS ? 'HubSpot' : 'GoHighLevel';
        const cls   = isHS ? 'hs' : 'ghl';
        const icon  = isHS ? 'HS' : 'GHL';
        const date  = l.linked_at ? 'Connected ' + new Date(l.linked_at).toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'}) : '';
        return `
        <div class="crm-row">
            <div class="crm-logo ${cls}">${icon}</div>
            <div class="crm-info">
                <div class="crm-name"><span class="dot-green"></span>${label}</div>
                <div class="crm-account">${l.session_name || l.crm_id || ''}</div>
                <div class="crm-date">${date}</div>
            </div>
            <button class="btn-text-danger" onclick="disconnectCRM('${l.crm_type}','${l.crm_id}')">Disconnect</button>
        </div>`;
    }).join('');

    // Update add button label
    document.getElementById('btn-add-crm').innerHTML = `
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
            <path d="M7 1v12M1 7h12" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
        </svg>
        Connect another CRM`;
}

function renderPhones(channels) {
    hide('phone-skel'); show('phone-content');
    const phones = channels.filter(c => c.channel_type === 'sms' || c.channel_type === 'whatsapp');
    const list = document.getElementById('phone-list');

    if (phones.length > 0) {
        list.innerHTML = phones.map(p => {
            const isSMS = p.channel_type === 'sms';
            const icon  = isSMS ? 'üí¨' : 'üì±';
            const num   = formatPhone(p.channel_id || '');
            const crm   = routeLabel(p.linked_crm || '');
            const date  = p.registered_at ? new Date(p.registered_at).toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'}) : '';
            return `
            <div class="phone-row">
                <div class="phone-icon">${icon}</div>
                <div class="phone-info">
                    <div class="phone-number"><span class="dot-green"></span>${num}</div>
                    <div class="phone-route">${crm}</div>
                    <div class="phone-date">${date ? 'Added ' + date : ''}</div>
                </div>
                <button class="btn-text-danger" onclick="disconnectPhone('${p.channel_type}','${encodeURIComponent(p.channel_id)}')">Remove</button>
            </div>`;
        }).join('');
        // Hide add section if phone already linked (show as collapsed add-more)
        document.getElementById('phone-add-section').innerHTML = `
            <button class="btn-add" onclick="showAddPhone(this)">
                <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                    <path d="M7 1v12M1 7h12" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                </svg>
                Add another number
            </button>`;
    } else {
        list.innerHTML = '';
        // Show registration form
    }
}

function showAddPhone(btn) {
    btn.replaceWith(buildPhoneForm());
}

function buildPhoneForm() {
    const wrap = document.createElement('div');
    wrap.className = 'phone-reg';
    wrap.id = 'phone-reg-inline';
    wrap.innerHTML = `
        <div id="phone-step-number-inline">
            <div class="input-row">
                <input id="inp-phone-inline" class="field-input" type="tel" placeholder="+1 555 000 0000">
                <button class="btn-sm blue" onclick="sendPhoneCode(true)">Send code</button>
            </div>
            <div id="phone-err-inline" class="phone-err"></div>
        </div>
        <div id="phone-step-otp-inline" class="hidden" style="margin-top:8px;">
            <p style="font-size:13px; color:var(--t2); margin-bottom:8px;">Enter the code sent to your number:</p>
            <div class="input-row">
                <input id="inp-phone-otp-inline" class="field-input" type="text" inputmode="numeric" maxlength="6" placeholder="000000">
                <button class="btn-sm blue" onclick="verifyPhoneCode(true)">Verify</button>
            </div>
            <div id="phone-otp-err-inline" class="phone-err"></div>
        </div>`;
    return wrap;
}

// Phone registration
async function sendPhoneCode(inline = false) {
    const sfx = inline ? '-inline' : '';
    const phone = document.getElementById('inp-phone' + sfx).value.trim();
    if (!phone) return;
    try {
        const r = await fetch(API + '/channels/sms/send-code', {
            method: 'POST', headers: auth(),
            body: JSON.stringify({ phone_number: phone })
        });
        if (!r.ok) { const d = await r.json(); showPhoneErr(d.detail || 'Failed to send code', sfx); return; }
        hide('phone-step-number' + sfx);
        show('phone-step-otp' + sfx);
        setTimeout(() => document.getElementById('inp-phone-otp' + sfx)?.focus(), 100);
    } catch(e) { showPhoneErr(e.message, sfx); }
}
async function verifyPhoneCode(inline = false) {
    const sfx   = inline ? '-inline' : '';
    const phone = document.getElementById('inp-phone' + sfx)?.value.trim() || document.getElementById('inp-phone-inline')?.value.trim() || '';
    const code  = document.getElementById('inp-phone-otp' + sfx).value.trim();
    if (code.length !== 6) { showPhoneErr('Enter the 6-digit code.', sfx); return; }
    try {
        const r = await fetch(API + '/channels/sms/verify-code', {
            method: 'POST', headers: auth(),
            body: JSON.stringify({ phone_number: phone, code })
        });
        if (!r.ok) { const d = await r.json(); showPhoneErr(d.detail || 'Invalid code', sfx); return; }
        toast('Phone number linked! üéâ', 'ok');
        loadUser();
    } catch(e) { showPhoneErr(e.message, sfx); }
}
function showPhoneErr(msg, sfx = '') {
    const el = document.getElementById('phone-err' + sfx) || document.getElementById('phone-otp-err' + sfx);
    if (el) { el.textContent = msg; el.style.display = 'block'; }
}

// Disconnect CRM
async function disconnectCRM(crm_type, crm_id) {
    if (!confirm('Disconnect ' + (crm_type === 'hubspot' ? 'HubSpot' : 'GoHighLevel') + '?')) return;
    try {
        await fetch(API + '/users/me/crm-links/' + crm_type + '/' + crm_id, {
            method: 'DELETE', headers: auth()
        });
        toast('CRM disconnected', 'ok');
        loadUser();
    } catch(e) { toast('Error disconnecting CRM', 'bad'); }
}

// Disconnect phone
async function disconnectPhone(channel_type, phone) {
    if (!confirm('Remove this phone number?')) return;
    try {
        await fetch(API + '/channels/' + channel_type + '/' + phone, {
            method: 'DELETE', headers: auth()
        });
        toast('Phone number removed', 'ok');
        loadUser();
    } catch(e) { toast('Error removing number', 'bad'); }
}

// Billing actions
async function startUpgrade() {
    try {
        const r = await fetch(API + '/billing/checkout', {
            method: 'POST', headers: auth(),
            body: JSON.stringify({ tier: 'starter' })
        });
        const d = await r.json();
        if (!r.ok) throw new Error(d.detail || 'Could not start checkout');
        if (d.url || d.checkout_url) location.href = d.url || d.checkout_url;
        else location.href = '/subscribe';
    } catch(e) { location.href = '/subscribe'; }
}
async function openPortal() {
    const btn = document.getElementById('btn-manage');
    btn.textContent = 'Opening‚Ä¶';
    btn.disabled = true;
    try {
        const r = await fetch(API + '/billing/portal', {
            method: 'POST', headers: auth()
        });
        const d = await r.json();
        if (!r.ok) throw new Error(d.detail);
        if (d.url || d.portal_url) location.href = d.url || d.portal_url;
    } catch(e) {
        toast(e.message || 'Could not open portal', 'bad');
        btn.textContent = 'Manage subscription';
        btn.disabled = false;
    }
}

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function formatPhone(p) {
    const d = p.replace(/\D/g,'');
    if (d.length === 11 && d[0] === '1') return '+1 (' + d.slice(1,4) + ') ' + d.slice(4,7) + '-' + d.slice(7);
    return p;
}
function routeLabel(linked_crm) {
    if (!linked_crm) return 'No CRM linked';
    if (linked_crm.toLowerCase().includes('hubspot')) return 'Routing to HubSpot';
    if (linked_crm.toLowerCase().includes('ghl') || linked_crm.toLowerCase().includes('highlevel')) return 'Routing to GoHighLevel';
    return 'Linked to ' + linked_crm;
}
function show(id) { document.getElementById(id)?.classList.remove('hidden'); }
function hide(id) { document.getElementById(id)?.classList.add('hidden'); }
function showErr(id, msg) { const el = document.getElementById(id); if (el) { el.textContent = msg; el.style.display = 'block'; } }
function clearErr(id)     { const el = document.getElementById(id); if (el) el.style.display = 'none'; }
function setBtnLoading(id, txt) { const b = document.getElementById(id); if(b){ b.disabled=true; b.textContent=txt; } }
function resetBtn(id, txt)      { const b = document.getElementById(id); if(b){ b.disabled=false; b.textContent=txt; } }
function toast(msg, type) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className = 'show ' + type;
    setTimeout(() => { el.className = type; }, 3200);
}

// Enter key support
document.addEventListener('keydown', e => {
    if (e.key !== 'Enter') return;
    const active = document.activeElement?.id;
    if (active === 'inp-email')     requestOtp();
    if (active === 'inp-otp')       verifyOtp();
    if (active === 'inp-phone' || active === 'inp-phone-inline') sendPhoneCode(active.includes('inline'));
    if (active === 'inp-phone-otp' || active === 'inp-phone-otp-inline') verifyPhoneCode(active.includes('inline'));
});
</script>
</body>
</html>
