<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlightSuite ‚Äî My Account</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" type="image/svg+xml" href="/Assets/Flight Suite Favicon vPurple.svg">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --color-apple-blue: #0071E3;
            --color-ios-purple: #5E5CE6;
            --color-success: #34C759;
            --color-error: #FF3B30;
            --color-warning: #FF9500;
            --color-text-primary: #1D1D1F;
            --color-text-secondary: #6E6E73;
            --color-text-tertiary: #86868B;
            --color-bg-primary: #FFFFFF;
            --color-bg-secondary: #F5F5F7;
            --color-border: #D2D2D7;
            --color-border-light: #E8E8ED;
            --gradient-primary: linear-gradient(135deg, var(--color-ios-purple) 0%, var(--color-apple-blue) 100%);
            --font-display: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            --font-body: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
            --ease-smooth: cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html { -webkit-font-smoothing: antialiased; }

        body {
            font-family: var(--font-body);
            color: var(--color-text-primary);
            background: var(--color-bg-secondary);
            font-size: 15px;
            line-height: 1.47;
            letter-spacing: -0.022em;
            min-height: 100vh;
        }

        /* ‚îÄ‚îÄ‚îÄ Topbar ‚îÄ‚îÄ‚îÄ */
        .topbar {
            background: rgba(255,255,255,0.85);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid var(--color-border-light);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .topbar-inner {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 24px;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .topbar-logo {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            font-family: var(--font-display);
            font-size: 17px;
            font-weight: 600;
            color: var(--color-text-primary);
            letter-spacing: -0.03em;
        }
        .topbar-logo img { width: 26px; height: 26px; }
        .topbar-nav { display: flex; align-items: center; gap: 8px; }
        .btn-signout {
            font-size: 13px;
            color: var(--color-text-secondary);
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 8px;
            transition: background 0.15s, color 0.15s;
            font-family: var(--font-body);
        }
        .btn-signout:hover { background: var(--color-bg-secondary); color: var(--color-text-primary); }

        /* ‚îÄ‚îÄ‚îÄ Layout ‚îÄ‚îÄ‚îÄ */
        .page { max-width: 1100px; margin: 0 auto; padding: 32px 24px 64px; }

        /* ‚îÄ‚îÄ‚îÄ Login Screen ‚îÄ‚îÄ‚îÄ */
        #login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(160deg, #f0f0f5 0%, #ffffff 60%);
        }
        .login-card {
            background: white;
            border-radius: 20px;
            padding: 48px 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 2px 40px rgba(0,0,0,0.08), 0 1px 3px rgba(0,0,0,0.05);
            text-align: center;
        }
        .login-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 28px;
        }
        .login-logo img { width: 36px; height: 36px; }
        .login-logo span {
            font-family: var(--font-display);
            font-size: 22px;
            font-weight: 700;
            color: var(--color-text-primary);
            letter-spacing: -0.04em;
        }
        .login-title {
            font-family: var(--font-display);
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.04em;
            margin-bottom: 6px;
        }
        .login-subtitle {
            color: var(--color-text-secondary);
            font-size: 14px;
            margin-bottom: 32px;
        }

        /* Google button */
        .btn-google {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 13px 20px;
            background: white;
            border: 1.5px solid var(--color-border);
            border-radius: 12px;
            font-family: var(--font-body);
            font-size: 15px;
            font-weight: 500;
            color: var(--color-text-primary);
            cursor: pointer;
            transition: border-color 0.15s, box-shadow 0.15s;
            margin-bottom: 20px;
        }
        .btn-google:hover { border-color: #aaa; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .btn-google svg { flex-shrink: 0; }

        .divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            color: var(--color-text-tertiary);
            font-size: 13px;
        }
        .divider::before, .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--color-border-light);
        }

        .form-group { text-align: left; margin-bottom: 12px; }
        .form-label { font-size: 13px; font-weight: 500; color: var(--color-text-secondary); margin-bottom: 6px; display: block; }
        .form-input {
            width: 100%;
            padding: 12px 14px;
            border: 1.5px solid var(--color-border);
            border-radius: 12px;
            font-family: var(--font-body);
            font-size: 15px;
            color: var(--color-text-primary);
            background: white;
            transition: border-color 0.15s, box-shadow 0.15s;
            outline: none;
        }
        .form-input:focus { border-color: var(--color-apple-blue); box-shadow: 0 0 0 3px rgba(0,113,227,0.12); }
        .form-input::placeholder { color: var(--color-text-tertiary); }

        .btn-primary {
            width: 100%;
            padding: 13px 20px;
            background: var(--color-apple-blue);
            color: white;
            border: none;
            border-radius: 12px;
            font-family: var(--font-body);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.15s, transform 0.1s;
            letter-spacing: -0.01em;
        }
        .btn-primary:hover { opacity: 0.88; }
        .btn-primary:active { transform: scale(0.98); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        /* OTP step */
        #otp-step { display: none; }
        .otp-back {
            font-size: 13px;
            color: var(--color-apple-blue);
            background: none;
            border: none;
            cursor: pointer;
            font-family: var(--font-body);
            margin-bottom: 16px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .otp-hint { font-size: 13px; color: var(--color-text-secondary); margin-top: 10px; text-align: center; }
        .otp-resend {
            background: none;
            border: none;
            color: var(--color-apple-blue);
            cursor: pointer;
            font-family: var(--font-body);
            font-size: 13px;
        }

        .login-error {
            background: rgba(255,59,48,0.08);
            border: 1px solid rgba(255,59,48,0.2);
            border-radius: 10px;
            padding: 10px 14px;
            font-size: 13px;
            color: var(--color-error);
            margin-bottom: 12px;
            display: none;
            text-align: left;
        }

        /* ‚îÄ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ‚îÄ */
        #dashboard-screen { display: none; }
        .dash-header { margin-bottom: 28px; }
        .dash-title {
            font-family: var(--font-display);
            font-size: clamp(26px, 3vw, 34px);
            font-weight: 700;
            letter-spacing: -0.04em;
        }
        .dash-subtitle { color: var(--color-text-secondary); font-size: 15px; margin-top: 4px; }

        /* Subscribed banner */
        .subscribed-banner {
            background: rgba(52,199,89,0.1);
            border: 1px solid rgba(52,199,89,0.3);
            border-radius: 14px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            font-size: 14px;
            color: #1c7a38;
        }

        /* Cards grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
        }

        .card {
            background: white;
            border-radius: 18px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04);
        }
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        .card-title {
            font-family: var(--font-display);
            font-size: 15px;
            font-weight: 600;
            letter-spacing: -0.02em;
        }
        .card-badge {
            font-size: 11px;
            font-weight: 600;
            padding: 3px 9px;
            border-radius: 20px;
            letter-spacing: 0.02em;
            text-transform: uppercase;
        }
        .badge-free { background: rgba(110,110,115,0.12); color: var(--color-text-secondary); }
        .badge-starter { background: rgba(0,113,227,0.1); color: var(--color-apple-blue); }
        .badge-pro { background: rgba(94,92,230,0.1); color: var(--color-ios-purple); }
        .badge-business { background: rgba(52,199,89,0.1); color: #1c7a38; }

        /* Usage bar */
        .usage-label {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: var(--color-text-secondary);
            margin-bottom: 6px;
        }
        .usage-bar {
            height: 6px;
            background: var(--color-bg-secondary);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 16px;
        }
        .usage-fill {
            height: 100%;
            border-radius: 3px;
            background: var(--gradient-primary);
            transition: width 0.6s var(--ease-out);
        }
        .usage-fill.warning { background: var(--color-warning); }
        .usage-fill.danger { background: var(--color-error); }

        .upgrade-link {
            font-size: 13px;
            color: var(--color-apple-blue);
            text-decoration: none;
            font-weight: 500;
        }
        .upgrade-link:hover { text-decoration: underline; }

        /* Phone section */
        .phone-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 14px;
            font-size: 14px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .status-dot.connected { background: var(--color-success); }
        .status-dot.disconnected { background: var(--color-border); }

        .phone-input-row { display: flex; gap: 8px; }
        .phone-input-row .form-input { flex: 1; }

        .btn-secondary {
            padding: 11px 16px;
            background: var(--color-bg-secondary);
            border: none;
            border-radius: 10px;
            font-family: var(--font-body);
            font-size: 14px;
            font-weight: 500;
            color: var(--color-text-primary);
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.15s;
        }
        .btn-secondary:hover { background: #e5e5ea; }
        .btn-secondary:disabled { opacity: 0.5; cursor: not-allowed; }

        /* CRM section */
        .crm-list { display: flex; flex-direction: column; gap: 10px; }
        .crm-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 14px;
            background: var(--color-bg-secondary);
            border-radius: 12px;
        }
        .crm-info { display: flex; align-items: center; gap: 10px; }
        .crm-icon {
            width: 34px;
            height: 34px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
        }
        .crm-icon.hs { background: rgba(255,122,0,0.12); color: #ff7a00; }
        .crm-icon.ghl { background: rgba(94,92,230,0.1); color: var(--color-ios-purple); }
        .crm-name { font-size: 14px; font-weight: 500; }
        .crm-status-text { font-size: 12px; color: var(--color-text-tertiary); }
        .crm-status-text.ok { color: var(--color-success); }

        .btn-connect {
            font-size: 13px;
            font-weight: 500;
            padding: 7px 14px;
            border-radius: 9px;
            border: 1.5px solid var(--color-border);
            background: white;
            cursor: pointer;
            font-family: var(--font-body);
            color: var(--color-text-primary);
            text-decoration: none;
            transition: border-color 0.15s, box-shadow 0.15s;
            display: inline-block;
        }
        .btn-connect:hover { border-color: var(--color-apple-blue); color: var(--color-apple-blue); }

        /* Spinner */
        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(0,0,0,0.1);
            border-top-color: var(--color-apple-blue);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            display: inline-block;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .hidden { display: none !important; }

        /* Period end */
        .period-end { font-size: 12px; color: var(--color-text-tertiary); margin-top: 4px; }

        /* Full width card */
        .card-full { grid-column: 1 / -1; }

        @media (max-width: 600px) {
            .login-card { padding: 36px 24px; margin: 16px; }
            .page { padding: 24px 16px 48px; }
        }
    </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="login-screen">
    <div class="login-card">
        <div class="login-logo">
            <img src="/Assets/Flight Suite Favicon vPurple.svg" alt="FlightSuite">
            <span>FlightSuite</span>
        </div>
        <h1 class="login-title">Sign in to your account</h1>
        <p class="login-subtitle">Manage your SMS credits, CRM connections, and phone number.</p>

        <!-- Google button (rendered by GIS) -->
        <div id="g-signin-btn" style="display:flex; justify-content:center; margin-bottom:20px;"></div>
        <!-- Fallback manual Google button shown until GIS loads -->
        <button id="google-btn-fallback" class="btn-google" onclick="signInWithGoogle()">
            <svg width="18" height="18" viewBox="0 0 18 18">
                <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"/>
                <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 0 0 9 18z"/>
                <path fill="#FBBC05" d="M3.964 10.706A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.706V4.962H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.038l3.007-2.332z"/>
                <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.962L3.964 7.294C4.672 5.163 6.656 3.58 9 3.58z"/>
            </svg>
            Continue with Google
        </button>

        <div class="divider">or</div>

        <!-- Email step -->
        <div id="email-step">
            <div id="login-error" class="login-error"></div>
            <div class="form-group">
                <label class="form-label" for="email-input">Email address</label>
                <input id="email-input" class="form-input" type="email" placeholder="you@company.com" autocomplete="email">
            </div>
            <button class="btn-primary" onclick="requestOtp()">Send sign-in code</button>
        </div>

        <!-- OTP step -->
        <div id="otp-step">
            <button class="otp-back" onclick="showEmailStep()">‚Üê Back</button>
            <div id="otp-error" class="login-error"></div>
            <div class="form-group">
                <label class="form-label" for="otp-input">6-digit code</label>
                <input id="otp-input" class="form-input" type="text" inputmode="numeric" maxlength="6" placeholder="000000" autocomplete="one-time-code">
            </div>
            <button class="btn-primary" onclick="verifyOtp()">Sign in</button>
            <p class="otp-hint">Didn't get it? <button class="otp-resend" onclick="requestOtp(true)">Resend</button></p>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="dashboard-screen">
    <div class="topbar">
        <div class="topbar-inner">
            <a href="/" class="topbar-logo">
                <img src="/Assets/Flight Suite Favicon vPurple.svg" alt="FlightSuite">
                FlightSuite
            </a>
            <div class="topbar-nav">
                <span id="topbar-email" style="font-size:13px; color:var(--color-text-tertiary);"></span>
                <button class="btn-signout" onclick="signOut()">Sign out</button>
            </div>
        </div>
    </div>

    <div class="page">
        <!-- Subscribed success banner -->
        <div id="subscribed-banner" class="subscribed-banner hidden">
            <span style="font-size:20px;">üéâ</span>
            <div>
                <strong>Subscription activated!</strong> Your SMS credits have been added to your account.
            </div>
        </div>

        <div class="dash-header">
            <h1 class="dash-title">My Account</h1>
            <p class="dash-subtitle">Manage your plan, phone, and CRM connections.</p>
        </div>

        <div class="cards-grid">

            <!-- ‚îÄ‚îÄ Usage Card ‚îÄ‚îÄ -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">SMS & WhatsApp Credits</div>
                    <span id="tier-badge" class="card-badge badge-free">Free</span>
                </div>
                <div id="usage-section">
                    <div class="usage-label">
                        <span id="usage-label-text">Credits used</span>
                        <span id="usage-numbers">‚Äî / ‚Äî</span>
                    </div>
                    <div class="usage-bar"><div id="usage-fill" class="usage-fill" style="width:0%"></div></div>
                </div>
                <p id="period-end-text" class="period-end hidden"></p>
                <a href="/subscribe" class="upgrade-link" id="upgrade-link" style="margin-top:8px; display:inline-block;">Upgrade plan ‚Üí</a>
            </div>

            <!-- ‚îÄ‚îÄ Phone Card ‚îÄ‚îÄ -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Phone Number</div>
                </div>
                <div id="phone-connected" class="hidden">
                    <div class="phone-status">
                        <div class="status-dot connected"></div>
                        <span id="linked-phone-display" style="font-size:14px; font-weight:500;"></span>
                    </div>
                    <p style="font-size:13px; color:var(--color-text-secondary);">Text or WhatsApp this number to update your CRM.</p>
                    <button class="btn-secondary" style="margin-top:14px; font-size:13px;" onclick="unlinkPhone()">Remove number</button>
                </div>
                <div id="phone-not-connected">
                    <div class="phone-status">
                        <div class="status-dot disconnected"></div>
                        <span style="font-size:14px; color:var(--color-text-secondary);">No phone linked</span>
                    </div>
                    <p style="font-size:13px; color:var(--color-text-secondary); margin-bottom:14px;">Link a phone number to use SMS & WhatsApp commands.</p>
                    <div id="phone-verify-step">
                        <div class="phone-input-row">
                            <input id="phone-input" class="form-input" type="tel" placeholder="+1 555 000 0000">
                            <button class="btn-secondary" onclick="sendPhoneCode()">Send code</button>
                        </div>
                    </div>
                    <div id="phone-otp-step" class="hidden" style="margin-top:10px;">
                        <p style="font-size:13px; color:var(--color-text-secondary); margin-bottom:8px;">Enter the code texted to you:</p>
                        <div class="phone-input-row">
                            <input id="phone-otp-input" class="form-input" type="text" inputmode="numeric" maxlength="6" placeholder="000000">
                            <button class="btn-secondary" onclick="verifyPhoneCode()">Verify</button>
                        </div>
                    </div>
                    <p id="phone-error" style="font-size:12px; color:var(--color-error); margin-top:8px; display:none;"></p>
                </div>
            </div>

            <!-- ‚îÄ‚îÄ CRM Card ‚îÄ‚îÄ -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">CRM Connections</div>
                    <a href="/app/connect" class="upgrade-link" style="font-size:13px;">Manage ‚Üí</a>
                </div>
                <div id="crm-loading" style="font-size:13px; color:var(--color-text-tertiary);">
                    <span class="spinner"></span> Loading‚Ä¶
                </div>
                <div id="crm-list" class="crm-list hidden"></div>
            </div>

        </div>
    </div>
</div>

<script>
    const API = 'https://treasonable-refugio-uncoincidentally.ngrok-free.dev/api/v1';
    let currentEmail = '';

    // ‚îÄ‚îÄ‚îÄ Token helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function getToken() { return localStorage.getItem('fs_user_token'); }
    function setToken(t) { localStorage.setItem('fs_user_token', t); }
    function clearToken() { localStorage.removeItem('fs_user_token'); localStorage.removeItem('fs_user_email'); }

    function authHeaders() {
        return { 'Authorization': 'Bearer ' + getToken(), 'Content-Type': 'application/json' };
    }

    // ‚îÄ‚îÄ‚îÄ Boot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    window.addEventListener('DOMContentLoaded', () => {
        initGoogleSignIn();
        if (getToken()) {
            showDashboard();
        } else {
            document.getElementById('login-screen').style.display = 'flex';
        }
        // Check for ?subscribed=true
        if (new URLSearchParams(location.search).get('subscribed') === 'true') {
            document.getElementById('subscribed-banner').classList.remove('hidden');
            history.replaceState({}, '', '/app');
        }
    });

    // ‚îÄ‚îÄ‚îÄ Google Sign-In ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function initGoogleSignIn() {
        if (typeof google === 'undefined') { return; }
        google.accounts.id.initialize({
            client_id: '1063285697384-4nqvgdp2ok8o98uusc1ql9qb8gbqsn04.apps.googleusercontent.com',
            callback: handleGoogleCredential
        });
        google.accounts.id.renderButton(
            document.getElementById('g-signin-btn'),
            { theme: 'outline', size: 'large', width: 340, text: 'continue_with' }
        );
        document.getElementById('google-btn-fallback').style.display = 'none';
    }

    function signInWithGoogle() {
        if (typeof google !== 'undefined') {
            google.accounts.id.prompt();
        }
    }

    async function handleGoogleCredential(response) {
        try {
            const res = await fetch(API + '/auth/google/token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id_token: response.credential })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.detail || 'Google sign-in failed');
            setToken(data.user_token);
            if (data.email) localStorage.setItem('fs_user_email', data.email);
            showDashboard();
        } catch (e) {
            showLoginError('login-error', e.message);
        }
    }

    // ‚îÄ‚îÄ‚îÄ Email OTP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function requestOtp(resend = false) {
        const email = document.getElementById('email-input').value.trim();
        if (!email) { showLoginError('login-error', 'Please enter your email address.'); return; }
        currentEmail = email;
        hideError('login-error');
        const btn = document.querySelector('#email-step .btn-primary');
        btn.disabled = true;
        btn.textContent = 'Sending‚Ä¶';
        try {
            const res = await fetch(API + '/auth/email/request-otp', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.detail || 'Failed to send code');
            document.getElementById('email-step').style.display = 'none';
            document.getElementById('otp-step').style.display = 'block';
        } catch (e) {
            showLoginError('login-error', e.message);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Send sign-in code';
        }
    }

    async function verifyOtp() {
        const code = document.getElementById('otp-input').value.trim();
        if (code.length !== 6) { showLoginError('otp-error', 'Enter the 6-digit code.'); return; }
        hideError('otp-error');
        const btn = document.querySelector('#otp-step .btn-primary');
        btn.disabled = true;
        btn.textContent = 'Verifying‚Ä¶';
        try {
            const res = await fetch(API + '/auth/email/verify-otp', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: currentEmail, code })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.detail || 'Invalid code');
            setToken(data.user_token);
            if (data.email) localStorage.setItem('fs_user_email', data.email);
            showDashboard();
        } catch (e) {
            showLoginError('otp-error', e.message);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Sign in';
        }
    }

    function showEmailStep() {
        document.getElementById('otp-step').style.display = 'none';
        document.getElementById('email-step').style.display = 'block';
        hideError('otp-error');
        hideError('login-error');
    }

    // ‚îÄ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showDashboard() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('dashboard-screen').style.display = 'block';
        const email = localStorage.getItem('fs_user_email') || '';
        document.getElementById('topbar-email').textContent = email;
        loadBillingStatus();
        loadChannels();
    }

    function signOut() {
        clearToken();
        location.reload();
    }

    // ‚îÄ‚îÄ‚îÄ Billing Status ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadBillingStatus() {
        try {
            const res = await fetch(API + '/billing/status', { headers: authHeaders() });
            if (res.status === 401) { signOut(); return; }
            const data = await res.json();
            renderBillingStatus(data);
        } catch(e) {
            // silently fail ‚Äî card shows defaults
        }
    }

    function renderBillingStatus(data) {
        const tier = (data.tier || 'free').toLowerCase();
        const used = data.queries_sms_used ?? data.queries_used ?? 0;
        const limit = data.queries_sms_limit ?? data.queries_limit ?? 20;
        const periodEnd = data.period_end;

        // Badge
        const badge = document.getElementById('tier-badge');
        badge.textContent = tier.charAt(0).toUpperCase() + tier.slice(1);
        badge.className = 'card-badge badge-' + tier;

        // Numbers
        document.getElementById('usage-numbers').textContent = used + ' / ' + (limit >= 99999 ? '‚àû' : limit);
        document.getElementById('usage-label-text').textContent = tier === 'free' ? 'Lifetime credits used' : 'Monthly credits used';

        // Bar
        const pct = limit > 0 ? Math.min((used / limit) * 100, 100) : 0;
        const fill = document.getElementById('usage-fill');
        fill.style.width = pct + '%';
        if (pct >= 90) fill.classList.add('danger');
        else if (pct >= 70) fill.classList.add('warning');

        // Period end
        if (periodEnd) {
            const d = new Date(periodEnd);
            document.getElementById('period-end-text').textContent = 'Resets ' + d.toLocaleDateString('en-US', {month:'long', day:'numeric', year:'numeric'});
            document.getElementById('period-end-text').classList.remove('hidden');
        }

        // Upgrade link
        if (tier !== 'free') {
            document.getElementById('upgrade-link').textContent = 'Manage plan ‚Üí';
            document.getElementById('upgrade-link').href = '/subscribe';
        }
    }

    // ‚îÄ‚îÄ‚îÄ Channels ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadChannels() {
        try {
            const res = await fetch(API + '/channels', { headers: authHeaders() });
            if (res.status === 401) { signOut(); return; }
            const data = await res.json();
            renderChannels(data);
        } catch(e) {
            renderChannels([]);
        }
    }

    function renderChannels(channels) {
        // Find phone channels
        const phones = channels.filter(c => c.channel_type === 'sms' || c.type === 'sms');
        if (phones.length > 0) {
            const ph = phones[0];
            document.getElementById('phone-connected').classList.remove('hidden');
            document.getElementById('phone-not-connected').style.display = 'none';
            document.getElementById('linked-phone-display').textContent = ph.phone || ph.phone_number || '';
        }

        // CRM channels
        document.getElementById('crm-loading').style.display = 'none';
        const crmList = document.getElementById('crm-list');
        crmList.classList.remove('hidden');

        const crms = [
            { id: 'hubspot', name: 'HubSpot', icon: 'HS', cls: 'hs' },
            { id: 'ghl', name: 'GoHighLevel', icon: 'GHL', cls: 'ghl' }
        ];
        crmList.innerHTML = crms.map(crm => {
            const linked = channels.find(c => (c.crm_type || c.type || '').toLowerCase().includes(crm.id));
            return `
            <div class="crm-item">
                <div class="crm-info">
                    <div class="crm-icon ${crm.cls}">${crm.icon}</div>
                    <div>
                        <div class="crm-name">${crm.name}</div>
                        <div class="crm-status-text ${linked ? 'ok' : ''}">${linked ? '‚óè Connected' : 'Not connected'}</div>
                    </div>
                </div>
                <a href="/app/connect" class="btn-connect">${linked ? 'Manage' : 'Connect'}</a>
            </div>`;
        }).join('');
    }

    // ‚îÄ‚îÄ‚îÄ Phone registration ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function sendPhoneCode() {
        const phone = document.getElementById('phone-input').value.trim();
        if (!phone) return;
        try {
            const res = await fetch(API + '/channels/sms/send-code', {
                method: 'POST',
                headers: authHeaders(),
                body: JSON.stringify({ phone_number: phone })
            });
            if (!res.ok) {
                const d = await res.json();
                showPhoneError(d.detail || 'Failed to send code');
                return;
            }
            document.getElementById('phone-verify-step').classList.add('hidden');
            document.getElementById('phone-otp-step').classList.remove('hidden');
        } catch(e) { showPhoneError(e.message); }
    }

    async function verifyPhoneCode() {
        const phone = document.getElementById('phone-input').value.trim();
        const code = document.getElementById('phone-otp-input').value.trim();
        if (code.length !== 6) { showPhoneError('Enter the 6-digit code.'); return; }
        try {
            const res = await fetch(API + '/channels/sms/verify-code', {
                method: 'POST',
                headers: authHeaders(),
                body: JSON.stringify({ phone_number: phone, code })
            });
            if (!res.ok) {
                const d = await res.json();
                showPhoneError(d.detail || 'Invalid code');
                return;
            }
            loadChannels();
        } catch(e) { showPhoneError(e.message); }
    }

    async function unlinkPhone() {
        if (!confirm('Remove your linked phone number?')) return;
        document.getElementById('phone-connected').classList.add('hidden');
        document.getElementById('phone-not-connected').style.display = 'block';
    }

    function showPhoneError(msg) {
        const el = document.getElementById('phone-error');
        el.textContent = msg;
        el.style.display = 'block';
    }

    // ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showLoginError(id, msg) {
        const el = document.getElementById(id);
        el.textContent = msg;
        el.style.display = 'block';
    }
    function hideError(id) {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    }

    // Enter key on email/otp inputs
    document.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
            if (document.getElementById('email-input') === document.activeElement) requestOtp();
            if (document.getElementById('otp-input') === document.activeElement) verifyOtp();
        }
    });
</script>
</body>
</html>
